syntax = "proto3";

package cloudsql.migration.v1;

option go_package = "github.com/yourorg/cloudsql-migrate/pkg/pb;pb";

// MigrationService provides gRPC API for CloudSQL migration management
service MigrationService {
  // GetVersion returns the current migration version
  rpc GetVersion(GetVersionRequest) returns (GetVersionResponse);

  // MigrateUp runs all pending migrations
  rpc MigrateUp(MigrateUpRequest) returns (MigrateUpResponse);

  // MigrateDown rolls back the last migration
  rpc MigrateDown(MigrateDownRequest) returns (MigrateDownResponse);

  // MigrateDownAll rolls back all migrations
  rpc MigrateDownAll(MigrateDownAllRequest) returns (MigrateDownAllResponse);

  // ForceVersion forces the migration version to a specific value
  rpc ForceVersion(ForceVersionRequest) returns (ForceVersionResponse);

  // CreateMigration creates a new migration file
  rpc CreateMigration(CreateMigrationRequest) returns (CreateMigrationResponse);
}

// DatabaseType represents the type of database
enum DatabaseType {
  DATABASE_TYPE_UNSPECIFIED = 0;
  DATABASE_TYPE_POSTGRES = 1;
  DATABASE_TYPE_MYSQL = 2;
}

// DatabaseConfig contains database connection configuration
message DatabaseConfig {
  // Database type
  DatabaseType db_type = 1;

  // Standard connection settings
  string host = 2;
  int32 port = 3;
  string user = 4;
  string password = 5;
  string database = 6;
  string ssl_mode = 7;

  // CloudSQL specific settings
  bool use_cloudsql = 8;
  string project_id = 9;
  string region = 10;
  string instance_name = 11;
  bool use_private_ip = 12;
}

// GetVersionRequest requests the current migration version
message GetVersionRequest {
  DatabaseConfig config = 1;
}

// GetVersionResponse returns the current migration version
message GetVersionResponse {
  uint32 version = 1;
  bool dirty = 2;
}

// MigrateUpRequest requests to run all pending migrations
message MigrateUpRequest {
  DatabaseConfig config = 1;
}

// MigrateUpResponse returns the result of running migrations
message MigrateUpResponse {
  bool success = 1;
  string message = 2;
}

// MigrateDownRequest requests to rollback the last migration
message MigrateDownRequest {
  DatabaseConfig config = 1;
}

// MigrateDownResponse returns the result of rolling back
message MigrateDownResponse {
  bool success = 1;
  string message = 2;
}

// MigrateDownAllRequest requests to rollback all migrations
message MigrateDownAllRequest {
  DatabaseConfig config = 1;
}

// MigrateDownAllResponse returns the result of rolling back all
message MigrateDownAllResponse {
  bool success = 1;
  string message = 2;
}

// ForceVersionRequest requests to force a specific migration version
message ForceVersionRequest {
  DatabaseConfig config = 1;
  uint32 version = 2;
}

// ForceVersionResponse returns the result of forcing version
message ForceVersionResponse {
  bool success = 1;
  string message = 2;
}

// CreateMigrationRequest requests to create a new migration file
message CreateMigrationRequest {
  DatabaseConfig config = 1;
  string name = 2;
}

// CreateMigrationResponse returns the result of creating migration
message CreateMigrationResponse {
  bool success = 1;
  string message = 2;
  string up_file = 3;
  string down_file = 4;
}
